---
tags:
  - rust
  - cpp
  - faiss
  - tantivy
  - filter
---

# 02 Tantivy with local Faiss

Take step back for Faiss, just combine faiss with tantivy using local files.

## Background

Previously we tested filter using faiss and tantivy using python bindings.
But we had a few issues:

- `search_preassigned` is not supported in python bindings
- within a cluster, we still need to use the tantivy search result as id selector

Things we need to do

- Add tantivy
- Generate embedding in rust
  - https://github.com/huggingface/candle/tree/main/candle-examples/examples/clip
  - https://github.com/EricLBuehler/mistral.rs uses candle but comes with many models
  - https://github.com/EricLBuehler/mistral.rs/blob/master/mistralrs/examples/qwen3_embedding/main.rs
  - https://github.com/huggingface/text-embeddings-inference a server with text embedding support
  - https://github.com/Anush008/fastembed-rs using ONNX and supports sentence transformer models

Tried `mistral.rs` it works

- `all-MiniLM-L6-v2` used by SentenceTransformer does not work because BERT model is not supported
- `google/embeddinggemma-300m` works, but requires HF auth
   - btw: load model took a while, even in rust ...

Let's start with text embedding and see if it works with faiss.

- We need to pass raw pointers to faiss for training
- Come up with a dataset, we can probably try the same hardcoded tennis dataset for now
- Write the design for filter using tantivy

## Build faiss index using vectors from rust

The interface from faiss is the following:

- a `const float*` pointer to the vectors
- a `idx_t` for the number of vectors

```cpp
void IndexIVF::train(idx_t n, const float* x);
void IndexIVF::add(idx_t n, const float* x);
```

The dimension of vectors are defined when creating the index and quantizer.

- `google/embeddinggemma-300m` generates 768 dimension with float32 by default

```cpp
const size_t VEC_DIM = 128;       // Vector dimension
const size_t N_CLUSTERS = 100;    // Number of IVF clusters

// Create index, default invert list implementation is memory
faiss::IndexFlatL2 quantizer(VEC_DIM);
faiss::IndexIVFFlat index(&quantizer, VEC_DIM, N_CLUSTERS);
```

The return type for embedding generated by mistral.rs is `Vec<Vec<f32>>`.

Now we need a method to pass

- name of the vector file
- dimension of vectors
- number of vectors
- vectors

We need to flatten `Vec<Vec<f32>>` to `const float*`

The interface that we got working is

- pass a rust `Vec<float>` to C++
- use `data.data()` to get the raw pointer

```cpp
void CreateExampleIVFIndexWithData(rust::Str index_file_name, size_t dim,
                                   size_t n_vectors, rust::Vec<float> data,
                                   size_t n_clusters) {
  index.train(N_VECTORS, data.data());
  index.add(N_VECTORS, data.data());
}
```

```rust
// lib.rs
fn CreateExampleIVFIndexWithData(
    index_file_name: &str,
    dim: usize,
    n_vectors: usize,
    data: Vec<f32>,
    n_clusters: usize,
);
```

## Build Tantivy index in rust

Copied some code from claude code, it compiles, what we really need are:

Let's use book as an example, we can use https://amazon-reviews-2023.github.io/ the amazon reviews dataset

We need to explore it using python scripts first to know what we are doing

```bash
pip install marimo
```

Use [amazon-reviews-converter.py](../amazon-reviews-converter.py) to convert the dataset to a csv file

```text
============================================================
DATA ANALYSIS WITH POLARS
============================================================

Total records: 89251

DataFrame shape: (89251, 7)

------------------------------------------------------------
UNIQUE MAIN CATEGORIES
------------------------------------------------------------
shape: (9, 2)
┌──────────────────────┬───────┐
│ main_category        ┆ count │
│ ---                  ┆ ---   │
│ str                  ┆ u32   │
╞══════════════════════╪═══════╡
│ Appstore for Android ┆ 68679 │
│ Software             ┆ 18791 │
│ null                 ┆ 1769  │
│ Gift Cards           ┆ 4     │
│ Home Audio & Theater ┆ 2     │
│ Books                ┆ 2     │
│ Computers            ┆ 2     │
│ AMAZON FASHION       ┆ 1     │
│ Toys & Games         ┆ 1     │
└──────────────────────┴───────┘

------------------------------------------------------------
CATEGORIES ANALYSIS
------------------------------------------------------------
Records with categories: 18791
Records without categories (null): 70460
Records without categories (empty string): 0

Top 20 individual categories:
shape: (20, 2)
┌──────────────────────────────┬───────┐
│ category_list                ┆ count │
│ ---                          ┆ ---   │
│ str                          ┆ u32   │
╞══════════════════════════════╪═══════╡
│ Software                     ┆ 18791 │
│ Education & Reference        ┆ 2716  │
│ Business & Office            ┆ 2322  │
│ Lifestyle & Hobbies          ┆ 1624  │
│ Photography & Graphic Design ┆ 1452  │
│ …                            ┆ …     │
│ All Microsoft                ┆ 621   │
│ Photography                  ┆ 613   │
│ Antivirus                    ┆ 590   │
│ Music                        ┆ 578   │
│ Internet Security Suites     ┆ 574   │
└──────────────────────────────┴───────┘

------------------------------------------------------------
AVERAGE RATING DISTRIBUTION
------------------------------------------------------------
shape: (1, 5)
┌──────────┬────────┬──────────┬─────┬─────┐
│ mean     ┆ median ┆ std      ┆ min ┆ max │
│ ---      ┆ ---    ┆ ---      ┆ --- ┆ --- │
│ f64      ┆ f64    ┆ f64      ┆ f64 ┆ f64 │
╞══════════╪════════╪══════════╪═════╪═════╡
│ 3.354704 ┆ 3.4    ┆ 0.815439 ┆ 0.0 ┆ 5.0 │
└──────────┴────────┴──────────┴─────┴─────┘

Rating distribution (binned):
shape: (5, 2)
┌────────────┬───────┐
│ rating_bin ┆ count │
│ ---        ┆ ---   │
│ cat        ┆ u32   │
╞════════════╪═══════╡
│ 0-1        ┆ 3125  │
│ 1-2        ┆ 3202  │
│ 2-3        ┆ 20441 │
│ 3-4        ┆ 49294 │
│ 4-5        ┆ 13189 │
└────────────┴───────┘

------------------------------------------------------------
RATING NUMBER DISTRIBUTION
------------------------------------------------------------
shape: (1, 5)
┌────────────┬────────┬──────────────┬─────┬─────────┐
│ mean       ┆ median ┆ std          ┆ min ┆ max     │
│ ---        ┆ ---    ┆ ---          ┆ --- ┆ ---     │
│ f64        ┆ f64    ┆ f64          ┆ i64 ┆ i64     │
╞════════════╪════════╪══════════════╪═════╪═════════╡
│ 606.175875 ┆ 11.0   ┆ 11594.907341 ┆ 0   ┆ 1898759 │
└────────────┴────────┴──────────────┴─────┴─────────┘

Rating number distribution:
  Zero ratings: 2959
  1-10 ratings: 40339
  11-100 ratings: 30512
  101-1000 ratings: 12083
  1000+ ratings: 3358

------------------------------------------------------------
PRICE DISTRIBUTION
------------------------------------------------------------
shape: (1, 5)
┌──────────┬────────┬───────────┬─────┬────────┐
│ mean     ┆ median ┆ std       ┆ min ┆ max    │
│ ---      ┆ ---    ┆ ---       ┆ --- ┆ ---    │
│ f64      ┆ f64    ┆ f64       ┆ f64 ┆ f64    │
╞══════════╪════════╪═══════════╪═════╪════════╡
│ 2.351605 ┆ 0.0    ┆ 22.814413 ┆ 0.0 ┆ 1998.0 │
└──────────┴────────┴───────────┴─────┴────────┘

Free apps (price = 0): 73044
Paid apps (price > 0): 16207
```